# WARNING: This file is managed by a script.
# Any changes made to this file will be overwritten.
# DO NOT EDIT THIS FILE MANUALLY.
cull:
  enabled: true
  every: 300
  timeout: 3600
global:
  safeToShowValues: false
hub:
  authenticatePrometheus: false
  command:
    - sh
    - -c
    - pip install boto3 && jupyterhub --config /usr/local/etc/jupyterhub/jupyterhub_config.py
  config:
    Authenticator:
      admin_users:
        - asmacdo
        - dandibot
        - satra
        - yarikoptic
    GitHubOAuthenticator:
      allowed_organizations:
        - brain-bican:kbhub-users
      client_id: ${client_id}
      client_secret: ${client_secret}
      oauth_callback_url: https://${jupyterhub_domain}/hub/oauth_callback
      scope:
        - read:org
        - read:gist
        - user:email
  db:
    pvc:
      storage: 50Gi
      storageClassName: gp3
  extraConfig:
    myConfig: |
      # Python executed by jupyterhub at startup
      from kubernetes_asyncio import client
      from oauthenticator.github import GitHubOAuthenticator
      def modify_pod_hook(spawner, pod):  # noqa
          pod.spec.containers[0].security_context = client.V1SecurityContext(privileged=True)
          return pod

      c.KubeSpawner.modify_pod_hook = modify_pod_hook  # noqa
      c.JupyterHub.authenticator_class = GitHubOAuthenticator  # noqa
      c.GitHubOAuthenticator.enable_auth_state = True  # noqa
prePuller:
  continuous:
    enabled: false
  hook:
    enabled: false
proxy:
  https:
    enabled: true
    hosts:
      - ${jupyterhub_domain}
    type: offload
  service:
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-backend-protocol: tcp
      service.beta.kubernetes.io/aws-load-balancer-connection-idle-timeout: '3600'
      service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: 'true'
      service.beta.kubernetes.io/aws-load-balancer-ip-address-type: ipv4
      service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
      service.beta.kubernetes.io/aws-load-balancer-ssl-cert: ${ssl_cert_arn}
      service.beta.kubernetes.io/aws-load-balancer-ssl-ports: https
      service.beta.kubernetes.io/aws-load-balancer-type: external
scheduling:
  podPriority:
    enabled: true
  userPlaceholder:
    enabled: false
    replicas: 1
  userPods:
    nodeAffinity:
      matchNodePurpose: require
  userScheduler:
    enabled: true
singleuser:
  allowPrivilegeEscalation: true
  cmd: null
  cpu:
    guarantee: 0.5
    limit: 12
  defaultUrl: /lab
  extraEnv:
    CHOWN_EXTRA: /home/shared
    CHOWN_HOME: 'yes'
    CHOWN_HOME_OPTS: -R
    GRANT_SUDO: 'yes'
    NOTEBOOK_ARGS: --allow-root
  extraPodConfig:
    securityContext:
      fsGroup: 100
  fsGid: 0
  initContainers:
    - command:
        - sh
        - -c
        - 'chmod 0775 /nfs; chown 1000:100 /nfs; chmod 0775 /shared; chown 1000:100
          /shared; chmod 0555 /readonly

          '
      image: alpine
      name: nfs-fixer
      securityContext:
        runAsUser: 0
      volumeMounts:
        - mountPath: /nfs
          name: persistent-storage
          subPath: home/{username}
        - mountPath: /shared
          name: persistent-storage
          subPath: shared
        - mountPath: /readonly
          name: persistent-storage
          subPath: readonly
  lifecycleHooks:
    postStart:
      exec:
        command:
          - sh
          - -c
          - '/opt/conda/envs/allen/bin/python -m ipykernel install --user --name allen
            --display-name "Python (Allen SDK)"; git config --global user.email "$${GITHUB_EMAIL}";
            git config --global user.name "$${GITHUB_USER}"

            '
  memory:
    guarantee: 1G
    limit: 16G
  profileList:
    - description: 0.5 CPU / 1 GB
      display_name: Tiny. Useful for many quick things
      kubespawner_override:
        cpu_guarantee: 0.25
        cpu_limit: 2
        image_pull_policy: Always
        mem_guarantee: 0.5G
        mem_limit: 2G
        node_selector:
          NodePool: default
      profile_options:
        image:
          choices:
            standard:
              default: true
              display_name: Standard
              kubespawner_override:
                image: ${singleuser_image_repo}:${singleuser_image_tag}
          display_name: Image
    - default: true
      description: 6 CPU / 16 GB up to 12C/32G. May take up to 15 mins to start.
      display_name: Base
      kubespawner_override:
        cpu_guarantee: 6
        cpu_limit: 12
        image_pull_policy: Always
        mem_guarantee: 16G
        mem_limit: 32G
        node_selector:
          NodePool: default
      profile_options:
        image:
          choices:
            matlab:
              display_name: MATLAB (must provide your own license)
              kubespawner_override:
                image: ${singleuser_image_repo}:${singleuser_image_tag}-matlab
            standard:
              default: true
              display_name: Standard
              kubespawner_override:
                image: ${singleuser_image_repo}:${singleuser_image_tag}
          display_name: Image
    - description: 12C/32G up to 24C/64G. May take up to 15 mins to start.
      display_name: Medium
      kubespawner_override:
        cpu_guarantee: 12
        cpu_limit: 24
        image_pull_policy: Always
        mem_guarantee: 32G
        mem_limit: 64G
        node_selector:
          NodePool: default
      profile_options:
        image:
          choices:
            matlab:
              display_name: MATLAB (must provide your own license)
              kubespawner_override:
                image: ${singleuser_image_repo}:${singleuser_image_tag}-matlab
            standard:
              default: true
              display_name: Standard
              kubespawner_override:
                image: ${singleuser_image_repo}:${singleuser_image_tag}
          display_name: Image
    - description: 24C/64G up to 48C/96G. May take up to 15 mins to start.
      display_name: Large
      kubespawner_override:
        cpu_guarantee: 24
        cpu_limit: 48
        image_pull_policy: Always
        mem_guarantee: 64G
        mem_limit: 96G
        node_selector:
          NodePool: default
      profile_options:
        image:
          choices:
            matlab:
              display_name: MATLAB (must provide your own license)
              kubespawner_override:
                image: ${singleuser_image_repo}:${singleuser_image_tag}-matlab
            standard:
              default: true
              display_name: Standard
              kubespawner_override:
                image: ${singleuser_image_repo}:${singleuser_image_tag}
          display_name: Image
    - description: 8 CPU / 30 GB / 1 T4 GPU. May take up to 15 mins to start.
      display_name: T4 GPU for inference
      kubespawner_override:
        cpu_guarantee: 6
        cpu_limit: 8
        extra_resource_limits:
          nvidia.com/gpu: '1'
        image_pull_policy: Always
        mem_guarantee: 25G
        mem_limit: 31G
        node_selector:
          NodePool: gpu
          node.kubernetes.io/instance-type: g4dn.2xlarge
        tolerations:
          - effect: NoSchedule
            key: nvidia.com/gpu
            operator: Exists
          - effect: NoSchedule
            key: hub.jupyter.org/dedicated
            operator: Equal
            value: user
      profile_options:
        image:
          choices:
            matlab:
              display_name: MATLAB GPU (must provide your own license)
              kubespawner_override:
                image: ${singleuser_image_repo}:${singleuser_image_tag}-gpu-matlab
            standard:
              default: true
              display_name: Standard GPU
              kubespawner_override:
                image: ${singleuser_image_repo}:${singleuser_image_tag}-gpu
          display_name: Image
  serviceAccountName: ${jupyter_single_user_sa_name}
  startTimeout: 2400
  storage:
    extraVolumeMounts:
      - mountPath: /dev/fuse
        name: fuse
      - mountPath: /dev/shm
        name: shm-volume
      - mountPath: /home/jovyan
        name: persistent-storage
        subPath: home/{username}
      - mountPath: /shared
        name: persistent-storage-shared
        subPath: shared
      - mountPath: /readonly
        name: persistent-storage-shared
        readOnly: true
        subPath: readonly
    extraVolumes:
      - hostPath:
          path: /dev/fuse
        name: fuse
      - emptyDir:
          medium: Memory
        name: shm-volume
      - name: persistent-storage-shared
        persistentVolumeClaim:
          claimName: efs-persist-shared
      - name: persistent-storage
        persistentVolumeClaim:
          claimName: efs-persist
    type: none
  uid: 0
